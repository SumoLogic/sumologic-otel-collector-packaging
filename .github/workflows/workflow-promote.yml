#################################################################################
# Workflow that orchestrates promotion across different systems
# All steps run in parallel and are completely independent
#################################################################################

name: Workflow-Promote

permissions:
  contents: read
  actions: write  # Needed to trigger other workflows

on:
  workflow_call:
    inputs:
      destination-channel:
        description: |
          The destination channel to promote packages to. Valid values are:
          - release-candidates
          - stable
        type: string
        required: true
      source-channel:
        description: |
          The source channel to promote packages from. Valid values are:
          - ci-builds
          - release-candidates
        type: string
        required: true
      version:
        description: The package version to promote.
        required: true
        type: string
      # Skip flags for manual re-runs
      skip-packagecloud:
        description: Skip PackageCloud promotion
        type: boolean
        default: false
      skip-legacy-s3:
        description: Skip legacy S3 bucket promotion
        type: boolean
        default: false
      skip-new-s3:
        description: Skip new S3 bucket promotion
        type: boolean
        default: false

defaults:
  run:
    shell: bash

jobs:
  # 1. PackageCloud Promotion (includes validation and source updates)
  promote-packagecloud:
    name: Promote PackageCloud
    if: ${{ !inputs.skip-packagecloud }}
    uses: ./.github/workflows/workflow-promote-packagecloud.yml
    with:
      source-channel: ${{ inputs.source-channel }}
      destination-channel: ${{ inputs.destination-channel }}
      version: ${{ inputs.version }}
    secrets: inherit

  # 2. Legacy S3 Bucket Promotion (includes destination updates)
  promote-legacy-s3:
    name: Promote Legacy S3
    if: ${{ !inputs.skip-legacy-s3 }}
    uses: ./.github/workflows/workflow-promote-legacy-s3.yml
    with:
      source-channel: ${{ inputs.source-channel }}
      destination-channel: ${{ inputs.destination-channel }}
      version: ${{ inputs.version }}
    secrets: inherit

  # 3. New S3 Bucket Promotion (includes destination updates)
  promote-new-s3:
    name: Promote New S3
    if: ${{ !inputs.skip-new-s3 }}
    uses: ./.github/workflows/workflow-promote-new-s3.yml
    with:
      source-channel: ${{ inputs.source-channel }}
      destination-channel: ${{ inputs.destination-channel }}
      version: ${{ inputs.version }}
    secrets: inherit

  # Summary job that reports results
  summary:
    name: Promotion Summary
    if: always()
    needs: [promote-packagecloud, promote-legacy-s3, promote-new-s3]
    runs-on: ubuntu-24.04
    steps:
      - name: Report Results
        env:
          VERSION: ${{ inputs.version }}
          SOURCE_CHANNEL: ${{ inputs.source-channel }}
          DESTINATION_CHANNEL: ${{ inputs.destination-channel }}
          PACKAGECLOUD_RESULT: ${{ needs.promote-packagecloud.result }}
          LEGACY_S3_RESULT: ${{ needs.promote-legacy-s3.result }}
          NEW_S3_RESULT: ${{ needs.promote-new-s3.result }}
          SKIP_PACKAGECLOUD: ${{ inputs.skip-packagecloud }}
          SKIP_LEGACY_S3: ${{ inputs.skip-legacy-s3 }}
          SKIP_NEW_S3: ${{ inputs.skip-new-s3 }}
        run: |
          {
            echo "## Promotion Summary"
            echo ""
            echo "**Version:** ${VERSION}"
            echo "**Promotion:** ${SOURCE_CHANNEL} → ${DESTINATION_CHANNEL}"
            echo ""
            echo "### Results:"
            
            if [ "${SKIP_PACKAGECLOUD}" = "true" ]; then
              echo "- **PackageCloud (includes validation & source updates):** ⏭️ Skipped"
            else
              echo "- **PackageCloud (includes validation & source updates):** ${PACKAGECLOUD_RESULT}"
            fi
            
            if [ "${SKIP_LEGACY_S3}" = "true" ]; then
              echo "- **Legacy S3 (includes destination updates):** ⏭️ Skipped"
            else
              echo "- **Legacy S3 (includes destination updates):** ${LEGACY_S3_RESULT}"
            fi
            
            if [ "${SKIP_NEW_S3}" = "true" ]; then
              echo "- **New S3 (includes destination updates):** ⏭️ Skipped"
            else
              echo "- **New S3 (includes destination updates):** ${NEW_S3_RESULT}"
            fi
            
            echo ""
            echo "### Manual Re-run Instructions:"
            echo "If any step failed, you can re-run specific parts by triggering this workflow with skip flags:"
            echo ""
            echo "\`\`\`yaml"
            echo "# To skip successful steps and only re-run failed ones:"
            
            if [ "${PACKAGECLOUD_RESULT}" = "success" ]; then
              echo "skip-packagecloud: true"
            fi
            if [ "${LEGACY_S3_RESULT}" = "success" ]; then
              echo "skip-legacy-s3: true"
            fi
            if [ "${NEW_S3_RESULT}" = "success" ]; then
              echo "skip-new-s3: true"
            fi
            
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
